{% extends "layout.html" %}

{% block title %}My Account - Dinger Tuesday{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-user-circle mr-2"></i>My Account</h4>
            </div>
            <div class="card-body">
                <div id="profile-success" class="alert alert-success" style="display: none;"></div>
                <div id="profile-error" class="alert alert-danger" style="display: none;"></div>
                
                <!-- User Info Section -->
                <div class="mb-4">
                    <h5 class="border-bottom pb-2">Account Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Email Address:</strong></label>
                                <p id="user-email" class="form-control-plaintext">Loading...</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Account Type:</strong></label>
                                <p id="user-provider" class="form-control-plaintext">Loading...</p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Member Since:</strong></label>
                                <p id="user-created" class="form-control-plaintext">Loading...</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Last Sign In:</strong></label>
                                <p id="user-last-signin" class="form-control-plaintext">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Display Name Section -->
                <div class="mb-4">
                    <h5 class="border-bottom pb-2">Profile Settings</h5>
                    <form id="profile-form">
                        <div class="form-group">
                            <label for="display-name">Display Name</label>
                            <input type="text" class="form-control" id="display-name" placeholder="Enter your display name">
                            <small class="form-text text-muted">This name will be shown on your comments and posts.</small>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span id="save-text">Save Changes</span>
                            <span id="save-loading" style="display: none;">
                                <span class="spinner-border spinner-border-sm" role="status"></span> Saving...
                            </span>
                        </button>
                    </form>
                </div>

                <!-- Account Actions -->
                <div class="mb-4">
                    <h5 class="border-bottom pb-2">Account Actions</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <button id="change-password-btn" class="btn btn-outline-secondary btn-block">
                                <i class="fas fa-key mr-2"></i>Change Password
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button id="delete-account-btn" class="btn btn-outline-danger btn-block">
                                <i class="fas fa-trash mr-2"></i>Delete Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cog mr-2"></i>Preferences</h5>
            </div>
            <div class="card-body">
                <form id="preferences-form">
                    <div class="form-group">
                        <label for="email-notifications">Email Notifications</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notify-articles" checked>
                            <label class="form-check-label" for="notify-articles">
                                New articles published
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notify-updates" checked>
                            <label class="form-check-label" for="notify-updates">
                                Daily stats updates
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="favorite-team">Favorite Team</label>
                        <select class="form-control" id="favorite-team">
                            <option value="">Select a team...</option>
                            <option value="LAA">Los Angeles Angels</option>
                            <option value="HOU">Houston Astros</option>
                            <option value="OAK">Oakland Athletics</option>
                            <option value="TOR">Toronto Blue Jays</option>
                            <option value="ATL">Atlanta Braves</option>
                            <option value="MIL">Milwaukee Brewers</option>
                            <option value="STL">St. Louis Cardinals</option>
                            <option value="CHC">Chicago Cubs</option>
                            <option value="ARI">Arizona Diamondbacks</option>
                            <option value="LAD">Los Angeles Dodgers</option>
                            <option value="SF">San Francisco Giants</option>
                            <option value="CLE">Cleveland Guardians</option>
                            <option value="SEA">Seattle Mariners</option>
                            <option value="FLA">Miami Marlins</option>
                            <option value="NYM">New York Mets</option>
                            <option value="WSH">Washington Nationals</option>
                            <option value="BAL">Baltimore Orioles</option>
                            <option value="SD">San Diego Padres</option>
                            <option value="PHI">Philadelphia Phillies</option>
                            <option value="PIT">Pittsburgh Pirates</option>
                            <option value="TEX">Texas Rangers</option>
                            <option value="TB">Tampa Bay Rays</option>
                            <option value="BOS">Boston Red Sox</option>
                            <option value="CIN">Cincinnati Reds</option>
                            <option value="COL">Colorado Rockies</option>
                            <option value="DET">Detroit Tigers</option>
                            <option value="KC">Kansas City Royals</option>
                            <option value="MIN">Minnesota Twins</option>
                            <option value="CWS">Chicago White Sox</option>
                            <option value="NYY">New York Yankees</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-block">Save Preferences</button>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-line mr-2"></i>Quick Stats</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h6 class="text-muted">Articles Read</h6>
                        <h4 class="text-primary">-</h4>
                    </div>
                    <div class="col-6">
                        <h6 class="text-muted">Days Active</h6>
                        <h4 class="text-success">-</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDmw8XHzlBo2lB8X1rzyjQbgd5aRkRilv0",
        authDomain: "dingertuesday-18a26.firebaseapp.com",
        projectId: "dingertuesday-18a26",
        storageBucket: "dingertuesday-18a26.firebasestorage.app",
        messagingSenderId: "649904034928",
        appId: "1:649904034928:web:03010b19c057bf4bcc10b5",
        measurementId: "G-H0ZR5N8SS8"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Check authentication state
    auth.onAuthStateChanged(function(user) {
        if (user) {
            loadUserInfo(user);
        } else {
            // Redirect to login if not authenticated
            window.location.href = '/login?return_url=' + encodeURIComponent(window.location.href);
        }
    });

    function loadUserInfo(user) {
        // Display user information
        document.getElementById('user-email').textContent = user.email || 'Not available';
        
        // Determine provider
        let provider = 'Email/Password';
        if (user.providerData && user.providerData.length > 0) {
            const providerData = user.providerData[0];
            if (providerData.providerId === 'google.com') {
                provider = 'Google Account';
            }
        }
        document.getElementById('user-provider').textContent = provider;
        
        // Format dates
        const createdDate = user.metadata.creationTime ? 
            new Date(user.metadata.creationTime).toLocaleDateString() : 'Not available';
        const lastSignIn = user.metadata.lastSignInTime ? 
            new Date(user.metadata.lastSignInTime).toLocaleDateString() : 'Not available';
            
        document.getElementById('user-created').textContent = createdDate;
        document.getElementById('user-last-signin').textContent = lastSignIn;
        
        // Set display name if available
        if (user.displayName) {
            document.getElementById('display-name').value = user.displayName;
        }
    }

    // Handle profile form submission
    document.getElementById('profile-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const displayName = document.getElementById('display-name').value.trim();
        
        // Show loading state
        document.getElementById('save-text').style.display = 'none';
        document.getElementById('save-loading').style.display = 'inline';
        
        try {
            const user = auth.currentUser;
            if (user) {
                await user.updateProfile({
                    displayName: displayName
                });
                
                showSuccess('Profile updated successfully!');
            }
        } catch (error) {
            console.error('Error updating profile:', error);
            showError('Failed to update profile: ' + error.message);
        } finally {
            // Reset button state
            document.getElementById('save-text').style.display = 'inline';
            document.getElementById('save-loading').style.display = 'none';
        }
    });

    // Handle preferences form
    document.getElementById('preferences-form').addEventListener('submit', function(e) {
        e.preventDefault();
        showSuccess('Preferences saved! (Feature coming soon)');
    });

    // Handle change password button
    document.getElementById('change-password-btn').addEventListener('click', function() {
        const user = auth.currentUser;
        if (user && user.email) {
            auth.sendPasswordResetEmail(user.email)
                .then(() => {
                    showSuccess('Password reset email sent to ' + user.email);
                })
                .catch((error) => {
                    showError('Failed to send password reset email: ' + error.message);
                });
        }
    });

    // Handle delete account button
    document.getElementById('delete-account-btn').addEventListener('click', function() {
        if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
            const user = auth.currentUser;
            if (user) {
                user.delete()
                    .then(() => {
                        alert('Account deleted successfully. You will be redirected to the home page.');
                        window.location.href = '/';
                    })
                    .catch((error) => {
                        showError('Failed to delete account: ' + error.message);
                    });
            }
        }
    });

    function showSuccess(message) {
        const successDiv = document.getElementById('profile-success');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        document.getElementById('profile-error').style.display = 'none';
        
        // Hide after 3 seconds
        setTimeout(() => {
            successDiv.style.display = 'none';
        }, 3000);
    }

    function showError(message) {
        const errorDiv = document.getElementById('profile-error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('profile-success').style.display = 'none';
    }
});
</script>
{% endblock %} 